name: Format Nixopus

on:
  push:
    branches:
      - master
      - feat/develop
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  format-api:
    name: Format API
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: "1.22"
          check-latest: true
          cache: true
          cache-dependency-path: api/go.sum

      - name: Run gofmt
        working-directory: api
        run: |
          echo "Running gofmt..."
          gofmt -l -w .
          git status

      - name: Commit API changes
        id: api-commit
        if: github.actor != 'github-actions[bot]'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style(api): format Go code [skip ci]"
          file_pattern: "api/**/*.go"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          skip_dirty_check: false
          skip_fetch: true
          skip_checkout: true
          disable_globbing: false

  format-view:
    name: Format View
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: view/yarn.lock

      - name: Install Yarn
        run: npm install -g yarn

      - name: Install dependencies
        working-directory: view
        run: yarn install --frozen-lockfile

      - name: Run Prettier
        working-directory: view
        run: yarn format

      - name: Commit View changes
        id: view-commit
        if: github.actor != 'github-actions[bot]'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style(view): format frontend code [skip ci]"
          file_pattern: "view/**"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          skip_dirty_check: false
          skip_fetch: true
          skip_checkout: true
          disable_globbing: false

  format-cli:
    name: Format CLI
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Install dependencies
        working-directory: cli
        run: poetry install --with dev --quiet

      - name: Run formatting
        working-directory: cli
        run: make format

      - name: Commit CLI changes
        id: cli-commit
        if: github.actor != 'github-actions[bot]'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "style(cli): format Python code [skip ci]"
          file_pattern: "cli/**/*.py"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          skip_dirty_check: false
          skip_fetch: true
          skip_checkout: true
          disable_globbing: false
