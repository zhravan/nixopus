metadata:
  id: "deploy-airsonic-advanced"
  name: "Airsonic Advanced"
  description: "Airsonic Advanced is a free, web-based media streamer, providing ubiquitous access to your music. Use it to share your music with friends, or to listen to your own music while at work. You can stream to multiple players simultaneously. Uses airsonic-advanced image from linuxserver.io"
  author: "Nixopus Team"
  icon: "ðŸŽµ"
  category: "Media"
  type: "install"
  version: "1.0.0"
  isVerified: false

variables:
  image:
    type: "string"
    description: "Docker image for Airsonic Advanced"
    default: "lscr.io/linuxserver/airsonic-advanced"
    is_required: true

  tag:
    type: "string"
    description: "Docker image tag"
    default: "latest"
    is_required: true

  container_name:
    type: "string"
    description: "Name of the Airsonic Advanced container"
    default: "airsonic-advanced"
    is_required: true

  host_port:
    type: "integer"
    description: "Host port to expose Airsonic Advanced WebUI"
    default: 4040
    is_required: true

  container_port:
    type: "integer"
    description: "Container port for Airsonic Advanced WebUI"
    default: 4040
    is_required: true

  config_volume_name:
    type: "string"
    description: "Named Docker volume for Airsonic Advanced configuration files"
    default: "airsonic-advanced-config"
    is_required: true

  music_volume_name:
    type: "string"
    description: "Named Docker volume for music files"
    default: "airsonic-music"
    is_required: true

  playlists_volume_name:
    type: "string"
    description: "Named Docker volume for playlists"
    default: "airsonic-playlists"
    is_required: true

  podcasts_volume_name:
    type: "string"
    description: "Named Docker volume for podcasts"
    default: "airsonic-podcasts"
    is_required: true

  media_volume_name:
    type: "string"
    description: "Named Docker volume for other media files (optional, set to empty to skip)"
    default: "airsonic-media"
    is_required: false

  puid:
    type: "integer"
    description: "User ID for running the container"
    default: 1000
    is_required: false

  pgid:
    type: "integer"
    description: "Group ID for running the container. For Java jukebox player, this should match the group of your sound device"
    default: 1000
    is_required: false

  timezone:
    type: "string"
    description: "Timezone (TZ) environment variable"
    default: "Etc/UTC"
    is_required: false

  context_path:
    type: "string"
    description: "Context path for URL-base in reverse proxy setups (optional)"
    default: ""
    is_required: false

  java_opts:
    type: "string"
    description: "Additional Java options (optional). For reverse proxies, use: -Dserver.use-forward-headers=true"
    default: ""
    is_required: false

  proxy_domain:
    type: "string"
    description: "Domain name for Airsonic Advanced (optional)"
    default: ""
    is_required: false

execution:
  run:
    - name: "Remove existing Airsonic Advanced container if present"
      type: "docker"
      properties:
        action: "rm"
        name: "{{ container_name }}"
      timeout: 30

    - name: "Pull Airsonic Advanced image"
      type: "docker"
      properties:
        action: "pull"
        image: "{{ image }}"
        tag: "{{ tag }}"
      timeout: 300

    - name: "Run Airsonic Advanced container"
      type: "docker"
      properties:
        action: "run"
        name: "{{ container_name }}"
        image: "{{ image }}"
        tag: "{{ tag }}"
        ports: "{{ host_port }}:{{ container_port }}"
        volumes:
          - "{{ config_volume_name }}:/config"
          - "{{ music_volume_name }}:/music"
          - "{{ playlists_volume_name }}:/playlists"
          - "{{ podcasts_volume_name }}:/podcasts"
          - "{{ media_volume_name }}:/media"
        env:
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          TZ: "{{ timezone }}"
          CONTEXT_PATH: "{{ context_path }}"
          JAVA_OPTS: "{{ java_opts }}"
        restart: "unless-stopped"
      timeout: 180

    - name: "Add proxy for Airsonic Advanced"
      type: "proxy"
      properties:
        action: "add"
        domain: "{{ proxy_domain }}"
        port: "{{ host_port }}"
      timeout: 30

  # validate:
  #   - name: "Check Airsonic Advanced WebUI is accessible"
  #     type: "command"
  #     properties:
  #       cmd: "sh -c 'for i in $(seq 1 30); do code=$(curl -fsS -o /dev/null -w \"%{http_code}\\n\" http://localhost:{{ host_port }} || true); echo \"HTTP $code\"; echo $code | grep -E \"^(200|301|302)$\" && exit 0; sleep 2; done; exit 1'"
  #     timeout: 60
