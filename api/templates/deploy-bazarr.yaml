metadata:
  id: "deploy-bazarr"
  name: "Bazarr"
  description: "Bazarr is a companion application to Sonarr and Radarr. It can manage and download subtitles based on your requirements. You define your preferences by TV show or movie and Bazarr takes care of everything for you. Uses bazarr image from linuxserver.io"
  author: "Nixopus Team"
  icon: "üìù"
  category: "Media"
  type: "install"
  version: "1.0.0"
  isVerified: false

variables:
  image:
    type: "string"
    description: "Docker image for Bazarr"
    default: "lscr.io/linuxserver/bazarr"
    is_required: true

  tag:
    type: "string"
    description: "Docker image tag (latest for stable releases, development for pre-releases)"
    default: "latest"
    is_required: true

  container_name:
    type: "string"
    description: "Name of the Bazarr container"
    default: "bazarr"
    is_required: true

  host_port:
    type: "integer"
    description: "Host port to expose Bazarr web UI"
    default: 6767
    is_required: true

  container_port:
    type: "integer"
    description: "Container port for Bazarr web UI"
    default: 6767
    is_required: true

  config_volume_name:
    type: "string"
    description: "Named Docker volume for Bazarr persistent configuration files"
    default: "bazarr-config"
    is_required: true

  movies_volume_name:
    type: "string"
    description: "Named Docker volume for movies location (optional)"
    default: "bazarr-movies"
    is_required: false

  tv_volume_name:
    type: "string"
    description: "Named Docker volume for TV shows location (optional)"
    default: "bazarr-tv"
    is_required: false

  puid:
    type: "integer"
    description: "User ID for running the container"
    default: 1000
    is_required: false

  pgid:
    type: "integer"
    description: "Group ID for running the container"
    default: 1000
    is_required: false

  timezone:
    type: "string"
    description: "Timezone (TZ) environment variable"
    default: "Etc/UTC"
    is_required: false

  proxy_domain:
    type: "string"
    description: "Domain name for Bazarr (optional)"
    default: ""
    is_required: false

execution:
  run:
    - name: "Remove existing Bazarr container if present"
      type: "docker"
      properties:
        action: "rm"
        name: "{{ container_name }}"
      timeout: 30

    - name: "Pull Bazarr image"
      type: "docker"
      properties:
        action: "pull"
        image: "{{ image }}"
        tag: "{{ tag }}"
      timeout: 300

    - name: "Run Bazarr container"
      type: "docker"
      properties:
        action: "run"
        name: "{{ container_name }}"
        image: "{{ image }}"
        tag: "{{ tag }}"
        ports: "{{ host_port }}:{{ container_port }}"
        volumes:
          - "{{ config_volume_name }}:/config"
          - "{{ movies_volume_name }}:/movies"
          - "{{ tv_volume_name }}:/tv"
        env:
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          TZ: "{{ timezone }}"
        restart: "unless-stopped"
      timeout: 120

    - name: "Add proxy for Bazarr"
      type: "proxy"
      properties:
        action: "add"
        domain: "{{ proxy_domain }}"
        port: "{{ host_port }}"
      timeout: 30

  # validate:
  #   - name: "Check Bazarr web UI is accessible"
  #     type: "command"
  #     properties:
  #       cmd: "sh -c 'for i in $(seq 1 30); do code=$(curl -fsS -o /dev/null -w \"%{http_code}\\n\" http://localhost:{{ host_port }} || true); echo \"HTTP $code\"; echo $code | grep -E \"^(200|301|302)$\" && exit 0; sleep 2; done; exit 1'"
  #     timeout: 60

