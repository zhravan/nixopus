metadata:
  id: "deploy-calibre-web"
  name: "Calibre-Web"
  description: "Calibre-Web is a web app providing a clean interface for browsing, reading and downloading eBooks using an existing Calibre database. It is also possible to integrate google drive and edit metadata and your calibre library through the app itself. Uses calibre-web image from linuxserver.io"
  author: "Nixopus Team"
  icon: "ðŸ“š"
  category: "Media"
  type: "install"
  version: "1.0.0"
  isVerified: false

variables:
  image:
    type: "string"
    description: "Docker image for Calibre-Web"
    default: "lscr.io/linuxserver/calibre-web"
    is_required: true

  tag:
    type: "string"
    description: "Docker image tag (latest for stable releases, nightly for master branch commits)"
    default: "latest"
    is_required: true

  container_name:
    type: "string"
    description: "Name of the Calibre-Web container"
    default: "calibre-web"
    is_required: true

  host_port:
    type: "integer"
    description: "Host port to expose Calibre-Web web UI"
    default: 8083
    is_required: true

  container_port:
    type: "integer"
    description: "Container port for Calibre-Web web UI"
    default: 8083
    is_required: true

  config_volume_name:
    type: "string"
    description: "Named Docker volume for Calibre-Web persistent configuration and internal database"
    default: "calibre-web-config"
    is_required: true

  books_volume_name:
    type: "string"
    description: "Named Docker volume for Calibre library location (contains preexisting calibre database)"
    default: "calibre-books"
    is_required: true

  puid:
    type: "integer"
    description: "User ID for running the container"
    default: 1000
    is_required: false

  pgid:
    type: "integer"
    description: "Group ID for running the container"
    default: 1000
    is_required: false

  timezone:
    type: "string"
    description: "Timezone (TZ) environment variable"
    default: "Etc/UTC"
    is_required: false

  docker_mods:
    type: "string"
    description: "Docker mods to enable additional functionality (optional, x86-64 only). Set to 'linuxserver/mods:universal-calibre' to enable ebook conversion"
    default: ""
    is_required: false

  oauthlib_relax_token_scope:
    type: "string"
    description: "Set to '1' to allow Google OAUTH to work (optional)"
    default: ""
    is_required: false

  proxy_domain:
    type: "string"
    description: "Domain name for Calibre-Web (optional)"
    default: ""
    is_required: false

execution:
  run:
    - name: "Remove existing Calibre-Web container if present"
      type: "docker"
      properties:
        action: "rm"
        name: "{{ container_name }}"
      timeout: 30

    - name: "Pull Calibre-Web image"
      type: "docker"
      properties:
        action: "pull"
        image: "{{ image }}"
        tag: "{{ tag }}"
      timeout: 300

    - name: "Run Calibre-Web container"
      type: "docker"
      properties:
        action: "run"
        name: "{{ container_name }}"
        image: "{{ image }}"
        tag: "{{ tag }}"
        ports: "{{ host_port }}:{{ container_port }}"
        volumes:
          - "{{ config_volume_name }}:/config"
          - "{{ books_volume_name }}:/books"
        env:
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          TZ: "{{ timezone }}"
          DOCKER_MODS: "{{ docker_mods }}"
          OAUTHLIB_RELAX_TOKEN_SCOPE: "{{ oauthlib_relax_token_scope }}"
        restart: "unless-stopped"
      timeout: 120

    - name: "Add proxy for Calibre-Web"
      type: "proxy"
      properties:
        action: "add"
        domain: "{{ proxy_domain }}"
        port: "{{ host_port }}"
      timeout: 30

  # validate:
  #   - name: "Check Calibre-Web web UI is accessible"
  #     type: "command"
  #     properties:
  #       cmd: "sh -c 'for i in $(seq 1 30); do code=$(curl -fsS -o /dev/null -w \"%{http_code}\\n\" http://localhost:{{ host_port }} || true); echo \"HTTP $code\"; echo $code | grep -E \"^(200|301|302)$\" && exit 0; sleep 2; done; exit 1'"
  #     timeout: 60
