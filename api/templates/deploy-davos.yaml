metadata:
  id: "deploy-davos"
  name: "Davos"
  description: "Davos is an FTP automation tool that periodically scans given host locations for new files. It can be configured for various purposes, including listening for specific files to appear in the host location, ready for it to download and then move, if required. It also supports completion notifications as well as downstream API calls, to further the workflow. Uses davos image from linuxserver.io"
  author: "Nixopus Team"
  icon: "ðŸ“¥"
  category: "Containers"
  type: "install"
  version: "1.0.0"
  isVerified: false

variables:
  image:
    type: "string"
    description: "Docker image for Davos"
    default: "lscr.io/linuxserver/davos"
    is_required: true

  tag:
    type: "string"
    description: "Docker image tag"
    default: "latest"
    is_required: true

  container_name:
    type: "string"
    description: "Name of the Davos container"
    default: "davos"
    is_required: true

  host_port:
    type: "integer"
    description: "Host port to expose Davos web UI"
    default: 8080
    is_required: true

  container_port:
    type: "integer"
    description: "Container port for Davos web UI"
    default: 8080
    is_required: true

  config_volume_name:
    type: "string"
    description: "Named Docker volume for Davos configuration, database, and logs"
    default: "davos-config"
    is_required: true

  download_volume_name:
    type: "string"
    description: "Named Docker volume for Davos file download location"
    default: "davos-download"
    is_required: true

  puid:
    type: "integer"
    description: "User ID for running the container"
    default: 1000
    is_required: false

  pgid:
    type: "integer"
    description: "Group ID for running the container"
    default: 1000
    is_required: false

  timezone:
    type: "string"
    description: "Timezone (TZ) environment variable"
    default: "Etc/UTC"
    is_required: false

  proxy_domain:
    type: "string"
    description: "Domain name for Davos (optional)"
    default: ""
    is_required: false

execution:
  run:
    - name: "Remove existing Davos container if present"
      type: "docker"
      properties:
        action: "rm"
        name: "{{ container_name }}"
      timeout: 30

    - name: "Pull Davos image"
      type: "docker"
      properties:
        action: "pull"
        image: "{{ image }}"
        tag: "{{ tag }}"
      timeout: 300

    - name: "Run Davos container"
      type: "docker"
      properties:
        action: "run"
        name: "{{ container_name }}"
        image: "{{ image }}"
        tag: "{{ tag }}"
        ports: "{{ host_port }}:{{ container_port }}"
        volumes:
          - "{{ config_volume_name }}:/config"
          - "{{ download_volume_name }}:/download"
        env:
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          TZ: "{{ timezone }}"
        restart: "unless-stopped"
      timeout: 120

    - name: "Add proxy for Davos"
      type: "proxy"
      properties:
        action: "add"
        domain: "{{ proxy_domain }}"
        port: "{{ host_port }}"
      timeout: 30

  # validate:
  #   - name: "Check Davos web UI is accessible"
  #     type: "command"
  #     properties:
  #       cmd: "sh -c 'for i in $(seq 1 30); do code=$(curl -fsS -o /dev/null -w \"%{http_code}\\n\" http://localhost:{{ host_port }} || true); echo \"HTTP $code\"; echo $code | grep -E \"^(200|301|302)$\" && exit 0; sleep 2; done; exit 1'"
  #     timeout: 60

