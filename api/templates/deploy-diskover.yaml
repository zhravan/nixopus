metadata:
  id: "deploy-diskover"
  name: "Diskover"
  description: "Diskover is an open source file system indexer that uses Elasticsearch to index and manage data across heterogeneous storage systems. This application is dependent on an ElasticSearch instance. Uses diskover image from linuxserver.io"
  author: "Nixopus Team"
  icon: "ðŸ“Š"
  category: "Containers"
  type: "install"
  version: "1.0.0"
  isVerified: false

variables:
  image:
    type: "string"
    description: "Docker image for Diskover"
    default: "lscr.io/linuxserver/diskover"
    is_required: true

  tag:
    type: "string"
    description: "Docker image tag"
    default: "latest"
    is_required: true

  container_name:
    type: "string"
    description: "Name of the Diskover container"
    default: "diskover"
    is_required: true

  host_port:
    type: "integer"
    description: "Host port to expose Diskover web UI"
    default: 80
    is_required: true

  container_port:
    type: "integer"
    description: "Container port for Diskover web UI"
    default: 80
    is_required: true

  config_volume_name:
    type: "string"
    description: "Named Docker volume for Diskover persistent configuration files"
    default: "diskover-config"
    is_required: true

  data_volume_name:
    type: "string"
    description: "Named Docker volume for default mount point to crawl (files to index)"
    default: "diskover-data"
    is_required: true

  puid:
    type: "integer"
    description: "User ID for running the container"
    default: 1000
    is_required: false

  pgid:
    type: "integer"
    description: "Group ID for running the container"
    default: 1000
    is_required: false

  timezone:
    type: "string"
    description: "Timezone (TZ) environment variable"
    default: "Etc/UTC"
    is_required: false

  es_host:
    type: "string"
    description: "ElasticSearch host (optional, e.g., elasticsearch container name or IP)"
    default: ""
    is_required: false

  es_port:
    type: "integer"
    description: "ElasticSearch port (optional)"
    default: 9200
    is_required: false

  proxy_domain:
    type: "string"
    description: "Domain name for Diskover (optional)"
    default: ""
    is_required: false

execution:
  run:
    - name: "Remove existing Diskover container if present"
      type: "docker"
      properties:
        action: "rm"
        name: "{{ container_name }}"
      timeout: 30

    - name: "Pull Diskover image"
      type: "docker"
      properties:
        action: "pull"
        image: "{{ image }}"
        tag: "{{ tag }}"
      timeout: 300

    - name: "Run Diskover container"
      type: "docker"
      properties:
        action: "run"
        name: "{{ container_name }}"
        image: "{{ image }}"
        tag: "{{ tag }}"
        ports: "{{ host_port }}:{{ container_port }}"
        volumes:
          - "{{ config_volume_name }}:/config"
          - "{{ data_volume_name }}:/data"
        env:
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          TZ: "{{ timezone }}"
          ES_HOST: "{{ es_host }}"
          ES_PORT: "{{ es_port }}"
        restart: "unless-stopped"
      timeout: 120

    - name: "Add proxy for Diskover"
      type: "proxy"
      properties:
        action: "add"
        domain: "{{ proxy_domain }}"
        port: "{{ host_port }}"
      timeout: 30

  # validate:
  #   - name: "Check Diskover web UI is accessible"
  #     type: "command"
  #     properties:
  #       cmd: "sh -c 'for i in $(seq 1 30); do code=$(curl -fsS -o /dev/null -w \"%{http_code}\\n\" http://localhost:{{ host_port }} || true); echo \"HTTP $code\"; echo $code | grep -E \"^(200|301|302)$\" && exit 0; sleep 2; done; exit 1'"
  #     timeout: 60

