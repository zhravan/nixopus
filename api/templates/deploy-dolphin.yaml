metadata:
  id: "deploy-dolphin"
  name: "Dolphin"
  description: "Dolphin Emulator lets you play GameCube and Wii games with various graphical enhancements and other features are available to improve your game experience. Uses dolphin image from linuxserver.io. HTTPS is required for full functionality. Note: This container provides privileged access - secure it properly. The web interface includes a terminal with passwordless sudo access. Note: The docs recommend --shm-size='1gb' but this is not directly supported by the docker action type."
  author: "Nixopus Team"
  icon: "üê¨"
  category: "Game"
  type: "install"
  version: "1.0.0"
  isVerified: false

variables:
  image:
    type: "string"
    description: "Docker image for Dolphin"
    default: "lscr.io/linuxserver/dolphin"
    is_required: true

  tag:
    type: "string"
    description: "Docker image tag"
    default: "latest"
    is_required: true

  container_name:
    type: "string"
    description: "Name of the Dolphin container"
    default: "dolphin"
    is_required: true

  http_host_port:
    type: "integer"
    description: "Host port for HTTP (must be proxied)"
    default: 3000
    is_required: true

  https_host_port:
    type: "integer"
    description: "Host port for HTTPS (primary access)"
    default: 3001
    is_required: true

  http_container_port:
    type: "integer"
    description: "Container port for HTTP"
    default: 3000
    is_required: true

  https_container_port:
    type: "integer"
    description: "Container port for HTTPS"
    default: 3001
    is_required: true

  config_volume_name:
    type: "string"
    description: "Named Docker volume for Dolphin configuration and user data (stores local files and settings)"
    default: "dolphin-config"
    is_required: true

  puid:
    type: "integer"
    description: "User ID for running the container"
    default: 1000
    is_required: false

  pgid:
    type: "integer"
    description: "Group ID for running the container"
    default: 1000
    is_required: false

  timezone:
    type: "string"
    description: "Timezone (TZ) environment variable"
    default: "Etc/UTC"
    is_required: false

  custom_user:
    type: "string"
    description: "HTTP Basic auth username (optional, default is abc)"
    default: ""
    is_required: false

  password:
    type: "string"
    description: "HTTP Basic auth password (optional, default is abc, leave empty for no auth)"
    default: ""
    is_required: false

  proxy_domain:
    type: "string"
    description: "Domain name for Dolphin HTTPS (optional, recommended for internet access)"
    default: ""
    is_required: false

execution:
  run:
    - name: "Remove existing Dolphin container if present"
      type: "docker"
      properties:
        action: "rm"
        name: "{{ container_name }}"
      timeout: 30

    - name: "Pull Dolphin image"
      type: "docker"
      properties:
        action: "pull"
        image: "{{ image }}"
        tag: "{{ tag }}"
      timeout: 300

    - name: "Run Dolphin container"
      type: "docker"
      properties:
        action: "run"
        name: "{{ container_name }}"
        image: "{{ image }}"
        tag: "{{ tag }}"
        ports: "{{ http_host_port }}:{{ http_container_port }},{{ https_host_port }}:{{ https_container_port }}"
        volumes:
          - "{{ config_volume_name }}:/config"
        env:
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          TZ: "{{ timezone }}"
          CUSTOM_USER: "{{ custom_user }}"
          PASSWORD: "{{ password }}"
        restart: "unless-stopped"
      timeout: 180

    - name: "Add proxy for Dolphin HTTPS"
      type: "proxy"
      properties:
        action: "add"
        domain: "{{ proxy_domain }}"
        port: "{{ https_host_port }}"
      timeout: 30

  # validate:
  #   - name: "Check Dolphin HTTPS interface is accessible"
  #     type: "command"
  #     properties:
  #       cmd: "sh -c 'for i in $(seq 1 30); do code=$(curl -fsSk -o /dev/null -w \"%{http_code}\\n\" https://localhost:{{ https_host_port }} || true); echo \"HTTP $code\"; echo $code | grep -E \"^(200|301|302)$\" && exit 0; sleep 2; done; exit 1'"
  #     timeout: 60

