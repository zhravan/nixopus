metadata:
  id: "deploy-duplicati"
  name: "Duplicati"
  description: "Duplicati is a backup client that securely stores encrypted, incremental, compressed backups on local storage, cloud storage services and remote file servers. It works with standard protocols like FTP, SSH, WebDAV as well as popular services like Microsoft OneDrive, Amazon S3, Google Drive, box.com, Mega, B2, and many others. Uses duplicati image from linuxserver.io"
  author: "Nixopus Team"
  icon: "ðŸ’¾"
  category: "Utility"
  type: "install"
  version: "1.0.0"
  isVerified: false

variables:
  image:
    type: "string"
    description: "Docker image for Duplicati"
    default: "lscr.io/linuxserver/duplicati"
    is_required: true

  tag:
    type: "string"
    description: "Docker image tag (latest for stable releases, development for beta releases)"
    default: "latest"
    is_required: true

  container_name:
    type: "string"
    description: "Name of the Duplicati container"
    default: "duplicati"
    is_required: true

  host_port:
    type: "integer"
    description: "Host port to expose Duplicati web UI"
    default: 8200
    is_required: true

  container_port:
    type: "integer"
    description: "Container port for Duplicati web UI"
    default: 8200
    is_required: true

  config_volume_name:
    type: "string"
    description: "Named Docker volume for Duplicati persistent configuration files"
    default: "duplicati-config"
    is_required: true

  backups_volume_name:
    type: "string"
    description: "Named Docker volume for storing local backups (optional)"
    default: "duplicati-backups"
    is_required: false

  source_volume_name:
    type: "string"
    description: "Named Docker volume for source files to backup (optional)"
    default: "duplicati-source"
    is_required: false

  puid:
    type: "integer"
    description: "User ID for running the container"
    default: 1000
    is_required: false

  pgid:
    type: "integer"
    description: "Group ID for running the container"
    default: 1000
    is_required: false

  timezone:
    type: "string"
    description: "Timezone (TZ) environment variable"
    default: "Etc/UTC"
    is_required: false

  settings_encryption_key:
    type: "string"
    description: "Encryption key for settings database (required, minimum 8 characters, alphanumeric)"
    default: ""
    is_required: true

  cli_args:
    type: "string"
    description: "Optionally specify any CLI variables you want to launch the app with"
    default: ""
    is_required: false

  webservice_password:
    type: "string"
    description: "Password for the web UI (optional, defaults to 'changeme' if unset, can be changed from web UI settings)"
    default: ""
    is_required: false

  proxy_domain:
    type: "string"
    description: "Domain name for Duplicati (optional)"
    default: ""
    is_required: false

execution:
  run:
    - name: "Remove existing Duplicati container if present"
      type: "docker"
      properties:
        action: "rm"
        name: "{{ container_name }}"
      timeout: 30

    - name: "Pull Duplicati image"
      type: "docker"
      properties:
        action: "pull"
        image: "{{ image }}"
        tag: "{{ tag }}"
      timeout: 300

    - name: "Run Duplicati container"
      type: "docker"
      properties:
        action: "run"
        name: "{{ container_name }}"
        image: "{{ image }}"
        tag: "{{ tag }}"
        ports: "{{ host_port }}:{{ container_port }}"
        volumes:
          - "{{ config_volume_name }}:/config"
          - "{{ backups_volume_name }}:/backups"
          - "{{ source_volume_name }}:/source"
        env:
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          TZ: "{{ timezone }}"
          SETTINGS_ENCRYPTION_KEY: "{{ settings_encryption_key }}"
          CLI_ARGS: "{{ cli_args }}"
          DUPLICATI__WEBSERVICE_PASSWORD: "{{ webservice_password }}"
        restart: "unless-stopped"
      timeout: 120

    - name: "Add proxy for Duplicati"
      type: "proxy"
      properties:
        action: "add"
        domain: "{{ proxy_domain }}"
        port: "{{ host_port }}"
      timeout: 30

  # validate:
  #   - name: "Check Duplicati web UI is accessible"
  #     type: "command"
  #     properties:
  #       cmd: "sh -c 'for i in $(seq 1 30); do code=$(curl -fsS -o /dev/null -w \"%{http_code}\\n\" http://localhost:{{ host_port }} || true); echo \"HTTP $code\"; echo $code | grep -E \"^(200|301|302)$\" && exit 0; sleep 2; done; exit 1'"
  #     timeout: 60

