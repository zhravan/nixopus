metadata:
  id: "deploy-hishtory-server"
  name: "hiSHtory Server"
  description: "hiSHtory is a better shell history. It stores your shell history in context (what directory you ran the command in, whether it succeeded or failed, how long it took, etc). This is all stored locally and end-to-end encrypted for syncing to all your other computers. Uses hishtory-server image from linuxserver.io"
  author: "Nixopus Team"
  icon: "ðŸ“œ"
  category: "Productivity"
  type: "install"
  version: "1.0.0"
  isVerified: false

variables:
  image:
    type: "string"
    description: "Docker image for hiSHtory Server"
    default: "lscr.io/linuxserver/hishtory-server"
    is_required: true

  tag:
    type: "string"
    description: "Docker image tag"
    default: "latest"
    is_required: true

  container_name:
    type: "string"
    description: "Name of the hiSHtory Server container"
    default: "hishtory-server"
    is_required: true

  api_host_port:
    type: "integer"
    description: "Host port for hiSHtory Server API"
    default: 8080
    is_required: true

  api_container_port:
    type: "integer"
    description: "Container port for hiSHtory Server API"
    default: 8080
    is_required: true

  config_volume_name:
    type: "string"
    description: "Named Docker volume for hiSHtory Server SQLite database (required if using SQLite, not needed for PostgreSQL)"
    default: "hishtory-server-config"
    is_required: false

  puid:
    type: "integer"
    description: "User ID for running the container"
    default: 1000
    is_required: false

  pgid:
    type: "integer"
    description: "Group ID for running the container"
    default: 1000
    is_required: false

  timezone:
    type: "string"
    description: "Timezone (TZ) environment variable"
    default: "Etc/UTC"
    is_required: false

  hishtory_postgres_db:
    type: "string"
    description: "PostgreSQL database connection URI (e.g., postgresql://user:pass@host:5432/hishtory?sslmode=disable). Special characters must be URL encoded. Don't set if using SQLite."
    default: ""
    is_required: false

  hishtory_sqlite_db:
    type: "string"
    description: "SQLite database path (e.g., /config/hishtory.db). Needs mounted volume for persistence. Don't set if using PostgreSQL."
    default: "/config/hishtory.db"
    is_required: false

  proxy_domain:
    type: "string"
    description: "Domain name for hiSHtory Server API (optional, recommended for internet access)"
    default: ""
    is_required: false

execution:
  run:
    - name: "Remove existing hiSHtory Server container if present"
      type: "docker"
      properties:
        action: "rm"
        name: "{{ container_name }}"
      timeout: 30

    - name: "Pull hiSHtory Server image"
      type: "docker"
      properties:
        action: "pull"
        image: "{{ image }}"
        tag: "{{ tag }}"
      timeout: 300

    - name: "Run hiSHtory Server container"
      type: "docker"
      properties:
        action: "run"
        name: "{{ container_name }}"
        image: "{{ image }}"
        tag: "{{ tag }}"
        ports: "{{ api_host_port }}:{{ api_container_port }}"
        volumes:
          - "{{ config_volume_name }}:/config"
        env:
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          TZ: "{{ timezone }}"
          HISHTORY_POSTGRES_DB: "{{ hishtory_postgres_db }}"
          HISHTORY_SQLITE_DB: "{{ hishtory_sqlite_db }}"
        restart: "unless-stopped"
      timeout: 180

    - name: "Add proxy for hiSHtory Server API"
      type: "proxy"
      properties:
        action: "add"
        domain: "{{ proxy_domain }}"
        port: "{{ api_host_port }}"
      timeout: 30

