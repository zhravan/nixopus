metadata:
  id: "deploy-mstream"
  name: "mStream"
  description: "mStream is a personal music streaming server. You can use mStream to stream your music from your home computer to any device, anywhere. There are mobile apps available for both Android and iPhone. Uses mstream image from linuxserver.io. Note: mStream v5 no longer accepts CLI arguments for user/password - configure via config.json instead."
  author: "Nixopus Team"
  icon: "ðŸŽµ"
  category: "Media"
  type: "install"
  version: "1.0.0"
  isVerified: false

variables:
  image:
    type: "string"
    description: "Docker image for mStream"
    default: "lscr.io/linuxserver/mstream"
    is_required: true

  tag:
    type: "string"
    description: "Docker image tag"
    default: "latest"
    is_required: true

  container_name:
    type: "string"
    description: "Name of the mStream container"
    default: "mstream"
    is_required: true

  host_port:
    type: "integer"
    description: "Host port for mStream web interface"
    default: 3000
    is_required: true

  container_port:
    type: "integer"
    description: "Container port for mStream web interface"
    default: 3000
    is_required: true

  config_volume_name:
    type: "string"
    description: "Named Docker volume for mStream configuration files"
    default: "mstream-data"
    is_required: true

  music_volume_name:
    type: "string"
    description: "Named Docker volume for music location"
    default: "mstream-music"
    is_required: true

  puid:
    type: "integer"
    description: "User ID for running the container"
    default: 1000
    is_required: false

  pgid:
    type: "integer"
    description: "Group ID for running the container"
    default: 1000
    is_required: false

  timezone:
    type: "string"
    description: "Timezone (TZ) environment variable"
    default: "Etc/UTC"
    is_required: false

  proxy_domain:
    type: "string"
    description: "Domain name for mStream web interface (optional, recommended for internet access)"
    default: ""
    is_required: false

execution:
  run:
    - name: "Remove existing mStream container if present"
      type: "docker"
      properties:
        action: "rm"
        name: "{{ container_name }}"
      timeout: 30

    - name: "Pull mStream image"
      type: "docker"
      properties:
        action: "pull"
        image: "{{ image }}"
        tag: "{{ tag }}"
      timeout: 300

    - name: "Run mStream container"
      type: "docker"
      properties:
        action: "run"
        name: "{{ container_name }}"
        image: "{{ image }}"
        tag: "{{ tag }}"
        ports: "{{ host_port }}:{{ container_port }}"
        volumes:
          - "{{ config_volume_name }}:/config"
          - "{{ music_volume_name }}:/music"
        env:
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          TZ: "{{ timezone }}"
        restart: "unless-stopped"
      timeout: 180

    - name: "Add proxy for mStream web interface"
      type: "proxy"
      properties:
        action: "add"
        domain: "{{ proxy_domain }}"
        port: "{{ host_port }}"
      timeout: 30

