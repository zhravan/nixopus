metadata:
  id: "deploy-netbootxyz"
  name: "Netbootxyz"
  description: "Netbootxyz is a way to PXE boot various operating system installers or utilities from one place within the BIOS without the need of having to go retrieve the media to run the tool. iPXE is used to provide a user friendly menu from within the BIOS. Uses netbootxyz image from linuxserver.io. DEPRECATED: This image is deprecated. Consider switching to https://github.com/netbootxyz/docker-netbootxyz for the official container which is a drop-in replacement."
  author: "Nixopus Team"
  icon: "ðŸ’¾"
  category: "Network"
  type: "install"
  version: "1.0.0"
  isVerified: false

variables:
  image:
    type: "string"
    description: "Docker image for Netbootxyz"
    default: "lscr.io/linuxserver/netbootxyz"
    is_required: true

  tag:
    type: "string"
    description: "Docker image tag (latest for web application, tftp for TFTP server only)"
    default: "latest"
    is_required: true

  container_name:
    type: "string"
    description: "Name of the Netbootxyz container"
    default: "netbootxyz"
    is_required: true

  webapp_host_port:
    type: "integer"
    description: "Host port for web configuration interface"
    default: 3000
    is_required: true

  webapp_container_port:
    type: "integer"
    description: "Container port for web configuration interface"
    default: 3000
    is_required: true

  tftp_host_port:
    type: "integer"
    description: "Host UDP port for TFTP"
    default: 69
    is_required: true

  tftp_container_port:
    type: "integer"
    description: "Container UDP port for TFTP"
    default: 69
    is_required: true

  nginx_host_port:
    type: "integer"
    description: "Host port for NGINX server hosting assets (optional)"
    default: 8080
    is_required: false

  nginx_container_port:
    type: "integer"
    description: "Container port for NGINX server hosting assets (optional)"
    default: 80
    is_required: false

  config_volume_name:
    type: "string"
    description: "Named Docker volume for boot menu files and web application config"
    default: "netbootxyz-config"
    is_required: true

  assets_volume_name:
    type: "string"
    description: "Named Docker volume for NETBOOT.XYZ bootable assets (live CDs and other files) (optional)"
    default: ""
    is_required: false

  puid:
    type: "integer"
    description: "User ID for running the container"
    default: 1000
    is_required: false

  pgid:
    type: "integer"
    description: "Group ID for running the container"
    default: 1000
    is_required: false

  timezone:
    type: "string"
    description: "Timezone (TZ) environment variable"
    default: "Etc/UTC"
    is_required: false

  menu_version:
    type: "string"
    description: "Specify a specific version of boot files you want to use from NETBOOT.XYZ (optional, unset pulls latest, e.g., 1.9.9)"
    default: ""
    is_required: false

  port_range:
    type: "string"
    description: "Specify the port range tftp will use for data transfers (optional, e.g., 30000:30010)"
    default: ""
    is_required: false

  subfolder:
    type: "string"
    description: "Specify a subfolder if running this behind a reverse proxy (optional, e.g., /proxy/)"
    default: "/"
    is_required: false

  nginx_port:
    type: "integer"
    description: "Specify a different internal port for the asset server (optional, default is 80)"
    default: 80
    is_required: false

  web_app_port:
    type: "integer"
    description: "Specify a different internal port for the configuration UI (optional, default is 3000)"
    default: 3000
    is_required: false

  proxy_domain:
    type: "string"
    description: "Domain name for Netbootxyz web configuration interface (optional, recommended for internet access)"
    default: ""
    is_required: false

execution:
  run:
    - name: "Remove existing Netbootxyz container if present"
      type: "docker"
      properties:
        action: "rm"
        name: "{{ container_name }}"
      timeout: 30

    - name: "Pull Netbootxyz image"
      type: "docker"
      properties:
        action: "pull"
        image: "{{ image }}"
        tag: "{{ tag }}"
      timeout: 300

    - name: "Run Netbootxyz container"
      type: "docker"
      properties:
        action: "run"
        name: "{{ container_name }}"
        image: "{{ image }}"
        tag: "{{ tag }}"
        ports: "{{ webapp_host_port }}:{{ webapp_container_port }},{{ tftp_host_port }}:{{ tftp_container_port }}/udp,{{ nginx_host_port }}:{{ nginx_container_port }}"
        volumes:
          - "{{ config_volume_name }}:/config"
          - "{{ assets_volume_name }}:/assets"
        env:
          PUID: "{{ puid }}"
          PGID: "{{ pgid }}"
          TZ: "{{ timezone }}"
          MENU_VERSION: "{{ menu_version }}"
          PORT_RANGE: "{{ port_range }}"
          SUBFOLDER: "{{ subfolder }}"
          NGINX_PORT: "{{ nginx_port }}"
          WEB_APP_PORT: "{{ web_app_port }}"
        restart: "unless-stopped"
      timeout: 180

    - name: "Add proxy for Netbootxyz web configuration interface"
      type: "proxy"
      properties:
        action: "add"
        domain: "{{ proxy_domain }}"
        port: "{{ webapp_host_port }}"
      timeout: 30

