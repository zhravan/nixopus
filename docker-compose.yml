version: '3.8'

services:
  nixopus-api:
    build:
      context: ./api
      dockerfile: Dockerfile
      args:
        - API_PORT=${API_PORT:-8443}
    container_name: nixopus-api-container
    ports:
      - "${API_PORT:-8443}:${API_PORT:-8443}"
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - HOST_NAME=nixopus-db
    volumes:
      - ./logs:/app/logs
      - ${DOCKER_CERT_PATH}:/etc/docker/certs
      - ${SSH_PRIVATE_KEY}:/root/.ssh/id_rsa
      - ${MOUNT_PATH:-/etc/nixopus/configs}:/etc/nixopus/configs
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - nixopus-network
    depends_on:
      nixopus-db:
        condition: service_healthy

  nixopus-db:
    image: postgres:14-alpine
    container_name: nixopus-db-container
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${USERNAME}
      - POSTGRES_PASSWORD=${PASSWORD}
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_HOST_AUTH_METHOD=trust
    ports:
      - "${DB_PORT:-5432}:5432"
    volumes:
      - ./data:/var/lib/postgresql/data
    networks:
      - nixopus-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${USERNAME} -d ${DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5
  
  nixopus-test-db:
    image: postgres:14-alpine
    container_name: nixopus-test-db-container
    ports:
      - "${TEST_DB_PORT:-5433}:5432"
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${TEST_DB_USERNAME:-nixopus}
      - POSTGRES_PASSWORD=${TEST_DB_PASSWORD:-nixopus}
      - POSTGRES_DB=${TEST_DB_NAME:-nixopus_test}
    networks:
      - nixopus-network
  
  nixopus-view:
    build:
      context: ./view
      dockerfile: Dockerfile
    container_name: nixopus-view-container
    ports:
      - "${NEXT_PUBLIC_PORT:-7443}:${NEXT_PUBLIC_PORT:-7443}"
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - ./logs:/app/logs
    networks:
      - nixopus-network
  
  nixopus-caddy:
    image: caddy:latest
    container_name: nixopus-caddy-container
    ports:
      - "2019:2019"
      - "80:80"
      - "443:443"
    volumes:
      - ./api/helpers/Caddyfile:/etc/caddy/Caddyfile
      - ./caddy_data:/data
      - ./caddy_config:/config
    networks:
      - nixopus-network

networks:
  nixopus-network:
    driver: bridge